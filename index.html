<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PapadSale - Gujarati Swad, Ghar-ghar Tak!</title>
  <meta name="description" content="Fresh homemade Gujarati snacks delivered to your doorstep. Order authentic papad, mathiya, khakhra and more with free delivery."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Client-side OCR to verify paid amount on screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    body{box-sizing:border-box}
    .font-baloo{font-family:"Baloo 2",cursive}
    .font-inter{font-family:"Inter",sans-serif}
    .bg-cream{background:#FEF7ED}
    .bg-saffron{background:#FF6A00}
    .text-saffron{color:#FF6A00}
    .soft-shadow{box-shadow:0 8px 32px rgba(255,106,0,.12)}
    .product-card{transition:.3s}
    .product-card:hover{transform:translateY(-4px);box-shadow:0 16px 48px rgba(255,106,0,.2)}
    .weight-toggle{transition:.2s}
    .weight-toggle.active{background:#FF6A00;color:#fff;border-color:#FF6A00;transform:scale(1.02)}

    /* Drawer FIX: use right property instead of transform so file input is always tappable */
    .cart-drawer{
      position: fixed;
      top: 0;
      right: -100%;
      height: 100%;
      width: 100%;
      transition: right .3s ease-in-out;
      will-change: right;
      z-index: 50;
      background:#fff;
      box-shadow:0 20px 60px rgba(0,0,0,.2);
    }
    @media (min-width:768px){ .cart-drawer{ width:24rem; } }
    .cart-drawer.open{ right: 0; }

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
    .modal.show{display:flex;align-items:center;justify-content:center}

    /* Small helpers for stars */
    .star{cursor:pointer; user-select:none}
    .star.on{color:#f59e0b}
  </style>
</head>
<body class="bg-cream font-inter">

  <!-- HEADER -->
  <header class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center overflow-hidden">
            <img src="assets/logo.png" alt="PapadSale Logo" class="w-8 h-8 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>
            <span class="text-saffron font-bold text-lg hidden">P</span>
          </div>
          <div>
            <h1 class="font-baloo font-bold text-xl text-saffron">PapadSale</h1>
            <p class="text-xs text-gray-600">Gujarati Swad, Ghar-ghar Tak!</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="toggleCart()" class="relative bg-saffron text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600">
            🛒 કાર્ટ
            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
          </button>
          <div class="text-right">
            <p class="text-sm text-gray-600">કુલ</p>
            <p id="cart-total-header" class="font-bold text-saffron">₹0</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- SIMPLE HERO -->
  <section class="py-12 text-center">
    <h2 class="font-baloo text-4xl text-saffron">સ્વાદિષ્ટ ગુજરાતી નાસ્તો</h2>
    <p class="max-w-2xl mx-auto mt-3 text-gray-700">Fresh homemade Gujarati snacks delivered to your doorstep. Experience authentic flavors with every bite!</p>
  </section>

  <!-- FILTERS -->
  <section class="py-6 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex flex-wrap justify-center gap-3">
        <button onclick="filterProducts('all')" class="filter-btn bg-saffron text-white px-4 py-2 rounded-full">બધું</button>
        <button onclick="filterProducts('papad')" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full border">પાપડ</button>
        <button onclick="filterProducts('mathiya')" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full border">મઠિયા</button>
        <button onclick="filterProducts('khakhra')" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full border">ખાખરા</button>
        <button onclick="filterProducts('snacks')" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full border">નાસ્તો</button>
        <button onclick="filterProducts('sweets')" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-full border">મિઠાઈ</button>
      </div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section class="py-10">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="products-grid"></div>
    </div>
  </section>

  <!-- STATS / TRACKER GRID -->
  <section class="py-12 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-10">
        <h3 class="font-baloo font-bold text-3xl text-gray-800">Why customers trust PapadSale</h3>
        <p class="text-gray-600">Real numbers from our kitchen to your home</p>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-cream rounded-2xl p-6 text-center soft-shadow">
          <p class="text-3xl font-bold text-saffron counter" data-target="576">0</p>
          <p class="text-gray-700 mt-1">Total Orders</p>
        </div>
        <div class="bg-cream rounded-2xl p-6 text-center soft-shadow">
          <p class="text-3xl font-bold text-saffron counter" data-target="660">0</p>
          <p class="text-gray-700 mt-1">Deliveries</p>
        </div>
        <div class="bg-cream rounded-2xl p-6 text-center soft-shadow">
          <p class="text-3xl font-bold text-saffron counter" data-target="300">0</p>
          <p class="text-gray-700 mt-1">Happy Customers</p>
        </div>
        <div class="bg-cream rounded-2xl p-6 text-center soft-shadow">
          <p class="text-3xl font-bold text-saffron counter" data-target="8">8</p>
          <p class="text-gray-700 mt-1">Areas Served</p>
        </div>
      </div>
    </div>
  </section>

  <!-- REVIEWS -->
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-10">
        <h3 class="font-baloo font-bold text-3xl text-gray-800">Customer Reviews</h3>
        <p class="text-gray-600">Hear it from those who’ve tasted the crunch!</p>
      </div>

      <!-- Review list -->
      <div id="reviews-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"></div>

      <!-- Add Review -->
      <div class="bg-white rounded-2xl p-6 soft-shadow max-w-3xl mx-auto">
        <h4 class="font-semibold mb-3">Add your review</h4>
        <div class="grid md:grid-cols-2 gap-3">
          <input id="rev-name" class="w-full p-3 border rounded-lg" placeholder="Your Name *"/>
          <input id="rev-city" class="w-full p-3 border rounded-lg" placeholder="City (Optional)"/>
        </div>
        <div class="mt-3">
          <span class="mr-2 text-sm text-gray-700">Your Rating:</span>
          <span id="rev-stars" class="text-2xl">
            <span class="star" data-v="1">★</span>
            <span class="star" data-v="2">★</span>
            <span class="star" data-v="3">★</span>
            <span class="star" data-v="4">★</span>
            <span class="star" data-v="5">★</span>
          </span>
        </div>
        <textarea id="rev-text" rows="4" class="w-full p-3 border rounded-lg mt-3" placeholder="Share your experience *"></textarea>
        <button onclick="submitReview()" class="mt-3 bg-saffron text-white px-5 py-3 rounded-lg font-semibold hover:bg-orange-600">Submit Review</button>
        <p id="rev-hint" class="text-xs text-gray-500 mt-2">Your review appears instantly and is saved on your device (localStorage).</p>
      </div>
    </div>
  </section>

  <!-- FAQs -->
  <section class="py-12 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-10">
        <h3 class="font-baloo font-bold text-3xl text-gray-800">FAQs</h3>
        <p class="text-gray-600">Everything you need to know</p>
      </div>
      <div class="max-w-4xl mx-auto space-y-3" id="faq-acc">
        <!-- items added via JS -->
      </div>
    </div>
  </section>

  <!-- CART DRAWER -->
  <div id="cart-drawer" class="cart-drawer">
    <div class="p-5">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-xl font-baloo font-bold">Your Cart</h3>
        <button onclick="toggleCart()" class="text-2xl text-gray-500">&times;</button>
      </div>

      <div id="cart-items" class="space-y-4 mb-6">
        <p class="text-gray-500 text-center py-8">Your cart is empty</p>
      </div>

      <!-- Upsell (appears when cart has items) -->
      <div id="upsell-section" class="mt-4 hidden">
        <h4 class="font-semibold mb-2">You may also like</h4>
        <div id="upsell-items" class="space-y-3"></div>
      </div>

      <div id="cart-total-block" class="border-t pt-4 mb-6 hidden">
        <div class="flex justify-between items-center text-lg font-bold">
          <span>Total:</span><span id="total-amount">₹0</span>
        </div>
      </div>

      <!-- CHECKOUT (UPI only) -->
      <div id="checkout-form" class="hidden">
        <h4 class="text-lg font-baloo font-bold mb-3">Delivery Details</h4>
        <div class="space-y-3">
          <input id="customer-name" class="w-full p-3 border rounded-lg" placeholder="Full Name *" required/>
          <input id="customer-mobile" class="w-full p-3 border rounded-lg" placeholder="Mobile Number (WhatsApp) *" pattern="[0-9]{10}" required/>
          <textarea id="customer-address" class="w-full p-3 border rounded-lg" rows="3" placeholder="Full Address *" required></textarea>
          <input id="customer-pincode" class="w-full p-3 border rounded-lg" placeholder="Pincode *" pattern="[0-9]{6}" required/>
          <input id="customer-landmark" class="w-full p-3 border rounded-lg" placeholder="Landmark (Optional)"/>
          <textarea id="order-notes" class="w-full p-3 border rounded-lg" rows="2" placeholder="Notes (Optional)"></textarea>
          <div class="p-3 rounded-lg bg-yellow-50 border border-yellow-200 text-sm">
            <strong>Payment Method: <span class="text-saffron">UPI Only</span></strong><br/>
            Scan and pay, then upload the payment screenshot for verification.
          </div>
        </div>

        <div class="space-y-3 mt-4">
          <button onclick="toggleCart()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">🛒 Update Cart</button>
          <a id="payUPI" href="#" class="block text-center w-full bg-saffron hover:bg-orange-600 text-white py-3 rounded-lg font-semibold">💳 Pay via UPI (opens your app)</a>
        </div>

        <!-- QR + Verification -->
        <div class="mt-5 p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-center">
          <h5 class="font-bold text-gray-800 mb-3">💳 Pay Papadsale via UPI</h5>
          <img src="assets/qr.png" alt="UPI QR Code" class="w-36 h-36 mx-auto rounded-lg border mb-3"/>
          <p class="text-sm text-gray-600 mb-2">After payment, upload the screenshot. We’ll verify the paid amount equals your total.</p>

          <!-- Larger tap target using label -->
          <label class="inline-block bg-saffron text-white px-4 py-2 rounded-lg cursor-pointer">
            📎 Upload Payment Screenshot
            <input id="payment-screenshot" type="file" accept="image/*" class="hidden">
          </label>
          <div id="ocr-status" class="text-xs text-gray-600 mt-2"></div>

          <label class="mt-3 inline-flex items-center gap-2 text-sm justify-center">
            <input id="send-summary-to-self" type="checkbox" class="rounded text-saffron" checked/>
            <span>Send order summary to my WhatsApp</span>
          </label>
          <button id="confirmPaymentBtn" onclick="confirmPaymentAndSend()" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold disabled:opacity-60" disabled>
            ✅ Confirm Payment & Send on WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div id="success-modal" class="modal">
    <div class="bg-white p-8 rounded-2xl max-w-md mx-4 text-center">
      <div class="text-6xl mb-4">✅</div>
      <h3 class="font-bold text-xl mb-2">Order Placed Successfully!</h3>
      <p class="text-gray-600 mb-6">We'll contact you shortly on WhatsApp to confirm your order.</p>
      <button onclick="closeModal()" class="bg-saffron text-white px-6 py-2 rounded-lg hover:bg-orange-600">Continue Shopping</button>
    </div>
  </div>

  <!-- FOOTER (expanded) -->
  <footer class="bg-gray-900 text-gray-300 pt-12">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8 pb-10 border-b border-gray-700">
        <div>
          <div class="flex items-center gap-2 mb-3">
            <img src="assets/logo.png" class="w-8 h-8" alt="logo" onerror="this.style.display='none'"/>
            <span class="font-baloo text-white font-bold text-xl">PapadSale</span>
          </div>
          <p class="text-sm">Authentic Gujarati snacks—freshly made, hygienic, and delivered with love.</p>
        </div>
        <div>
          <h5 class="text-white font-semibold mb-3">Quick Links</h5>
          <ul class="space-y-2 text-sm">
            <li><a href="#" class="hover:text-white">Home</a></li>
            <li><a href="#products-grid" class="hover:text-white">Products</a></li>
            <li><a href="#reviews-list" class="hover:text-white">Reviews</a></li>
            <li><a href="#faq-acc" class="hover:text-white">FAQs</a></li>
          </ul>
        </div>
        <div>
          <h5 class="text-white font-semibold mb-3">Contact</h5>
          <ul class="space-y-2 text-sm">
            <li>📍 Ahmedabad, Gujarat</li>
            <li>📞 <a href="https://wa.me/919978113276" class="hover:text-white">+91 99781 13276</a></li>
            <li>✉️ info@papadsale.com</li>
            <li>UPI: <span class="text-white">food53.06@idfcbank</span></li>
          </ul>
        </div>
        <div>
          <h5 class="text-white font-semibold mb-3">Follow</h5>
          <div class="flex gap-3 text-lg">
            <a class="hover:text-white" href="#" aria-label="Instagram">📸</a>
            <a class="hover:text-white" href="#" aria-label="Facebook">👍</a>
            <a class="hover:text-white" href="#" aria-label="Twitter">🐦</a>
          </div>
        </div>
      </div>
      <div class="py-6 text-center text-sm text-gray-400">
        © 2024 PapadSale. All rights reserved.
      </div>
    </div>
  </footer>

  <!-- APP SCRIPT -->
  <script>
  /********** CONFIG **********/
  const ADMIN_WHATSAPP = '919978113276';      // your WhatsApp (no +)
  const OCR_TOLERANCE  = 2;                   // ₹ tolerance for amount match
  const ADMIN_UPLOAD_ENDPOINT = '';           // optional backend to host screenshot (returns {url})
  const SHOP_NAME = 'Papadsale';
  const UPI_VPA = 'food53.06@idfcbank';       // updated UPI ID

  /********** DATA **********/
  const products = [
    { id:1, name:"ગ્રીન ચીલી ખીચિયા પાપડ", nameEn:"Green Chili Khichiya Papad", price250:90, price500:180, image:"papad1.jpg", category:"papad" },
    { id:2, name:"આસ્વાદ સાદા મઠિયા", nameEn:"Aswad Plain Mathiya", price250:100, price500:200, image:"mathiya1.jpg", category:"mathiya" },
    { id:3, name:"આસ્વાદ લીલા મરચા મઠિયા", nameEn:"Aswad Green Chili Mathiya", price250:110, price500:220, image:"mathiya1.jpg", category:"mathiya" },
    { id:4, name:"આસ્વાદ ચોળાફળી", nameEn:"Aswad Cholafali", price250:100, price500:200, image:"chorafali1.jpg", category:"snacks" },
    { id:5, name:"યશ લીલા મરચા મઠિયા", nameEn:"Yash Green Chili Mathiya", price250:150, price500:300, image:"combomathiyachorafali.png", category:"mathiya" },
    { id:6, name:"યશ સાદા મઠિયા", nameEn:"Yash Plain Mathiya", price250:140, price500:280, image:"combomathiyachorafali.png", category:"mathiya" },
    { id:7, name:"યશ ચોળાફળી", nameEn:"Yash Cholafali", price250:140, price500:280, image:"chorafali1.jpg", category:"snacks" },
    { id:8, name:"મેથી / મસાલા ખાખરા", nameEn:"Methi / Masala Khakhra", price250:100, price500:200, image:"khakhra1.jpg", category:"khakhra" },
    { id:9, name:"મઠ / જુવાર / રાગી ખાખરા", nameEn:"Math / Juwar / Ragi Khakhra", price250:135, price500:270, image:"khakhra1.jpg", category:"khakhra" },
    { id:10, name:"બિસ્કિટ/નાનખટાઈ", nameEn:"Biscuit/Nankhatai", price250:70, price500:140, image:"combomathiyachorafali.png", category:"sweets" },
    { id:11, name:"ડ્રાય કચોરી", nameEn:"Dry Kachori", price250:70, price500:140, image:"chorafali1.jpg", category:"snacks" }
  ];

  const seedReviews = [
    {name:'Priya S.', city:'Vadodara', rating:5, text:'Mathiya is super crispy and fresh. Loved the packaging too!'},
    {name:'Rahul P.', city:'Ahmedabad', rating:4, text:'Khakhra quality is great. Delivery was quick.'},
    {name:'Kajal T.', city:'Surat', rating:5, text:'Chorafali took me back to festivals at home. Must try!'}
  ];

  const faqs = [
    {q:'Do you offer free delivery?', a:'Yes, we offer free delivery on qualifying orders within serviceable areas.'},
    {q:'How fresh are the snacks?', a:'Everything is made in small batches for optimal freshness and hygienic handling.'},
    {q:'What payment methods do you accept?', a:'UPI only for now. Pay using the UPI button or QR and upload your screenshot.'},
    {q:'What is the delivery time?', a:'Typically 1–3 days depending on your city and product availability.'},
  ];

  /********** STATE **********/
  let cart = [];
  let currentFilter = 'all';
  let uploadedScreenshotFile = null;
  let uploadedScreenshotURL  = '';  // if backend returns URL
  let ocrDetectedAmount = null;
  let currentStars = 5;

  /********** HELPERS **********/
  const $ = (id)=>document.getElementById(id);
  const money = (n)=>`₹${n}`;
  const cartTotal = ()=>cart.reduce((s,i)=>s+i.price*i.quantity,0);
  function toast(msg){
    const t=document.createElement('div');
    t.className='fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow z-50';
    t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
  }

  /********** PRODUCTS **********/
  function renderProducts(){
    const grid = $('products-grid');
    const items = currentFilter==='all' ? products : products.filter(p=>p.category===currentFilter);
    grid.innerHTML = items.map(p=>`
      <div class="product-card bg-white rounded-2xl p-6 soft-shadow">
        <div class="text-center mb-4">
          <div class="w-32 h-32 mx-auto mb-3 rounded-lg overflow-hidden bg-gray-100">
            <img src="assets/${p.image}" alt="${p.nameEn}" class="w-full h-full object-cover"/>
          </div>
          <h3 class="font-baloo font-semibold text-lg text-gray-800 mb-1">${p.name}</h3>
          <p class="text-sm text-gray-600">${p.nameEn}</p>
        </div>
        <div class="space-y-3">
          <div class="flex justify-center gap-2">
            <button class="weight-toggle px-4 py-2 border-2 border-gray-300 rounded-lg text-sm" id="weight-250-${p.id}" onclick="selectWeight(${p.id},250)">250g - ${money(p.price250)}</button>
            <button class="weight-toggle active px-4 py-2 border-2 border-[#FF6A00] rounded-lg text-sm" id="weight-500-${p.id}" onclick="selectWeight(${p.id},500)">500g - ${money(p.price500)}</button>
          </div>
          <div class="flex items-center justify-center gap-3">
            <button class="w-8 h-8 bg-gray-200 rounded-full text-lg font-bold" onclick="qtyCh(${p.id},-1)">-</button>
            <span class="font-semibold text-lg w-8 text-center" id="qty-${p.id}">1</span>
            <button class="w-8 h-8 bg-gray-200 rounded-full text-lg font-bold" onclick="qtyCh(${p.id},1)">+</button>
          </div>
          <button class="w-full bg-saffron text-white py-3 rounded-xl font-semibold hover:bg-orange-600" onclick="addToCart(${p.id})">કાર્ટમાં ઉમેરો</button>
        </div>
      </div>
    `).join('');
  }
  function filterProducts(cat){
    currentFilter=cat; renderProducts();
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('bg-saffron','text-white'));
    if (event && event.target) event.target.classList.add('bg-saffron','text-white');
  }
  function selectWeight(id,w){
    $('weight-250-'+id).classList.toggle('active',w===250);
    $('weight-500-'+id).classList.toggle('active',w===500);
  }
  function qtyCh(id,d){ const el=$('qty-'+id); el.textContent=Math.max(1,(parseInt(el.textContent)||1)+d); }

  /********** CART **********/
  function addToCart(id){
    const p=products.find(x=>x.id===id);
    const qty=parseInt($('qty-'+id).textContent)||1;
    const w=$('weight-500-'+id).classList.contains('active')?500:250;
    const price = w===500?p.price500:p.price250;
    const existing = cart.find(i=>i.id===id && i.weight===w);
    if (existing) existing.quantity+=qty; else cart.push({id:p.id,name:p.name,nameEn:p.nameEn,weight:w,price,quantity:qty,image:p.image});
    $('qty-'+id).textContent='1';
    updateCartUI(); toast('પ્રોડક્ટ કાર્ટમાં ઉમેરાઈ!');
  }
  function changeCartQuantity(id,weight,delta){
    const it=cart.find(i=>i.id===id && i.weight===weight); if(!it) return;
    it.quantity=Math.max(1, it.quantity+delta); updateCartUI();
  }
  function removeFromCart(index){ cart.splice(index,1); updateCartUI(); }
  function toggleCart(){ $('cart-drawer').classList.toggle('open'); }

  function updateCartUI(){
    const count=cart.reduce((s,i)=>s+i.quantity,0);
    const total=cartTotal();
    $('cart-count').textContent=count; $('cart-total-header').textContent=money(total);
    const list=$('cart-items');
    if(!cart.length){
      list.innerHTML='<p class="text-gray-500 text-center py-8">Your cart is empty</p>';
      $('cart-total-block').classList.add('hidden');
      $('checkout-form').classList.add('hidden');
      $('upsell-section').classList.add('hidden');
      return;
    }
    list.innerHTML = cart.map((item,idx)=>`
      <div class="flex items-center justify-between p-4 border-b">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100">
            <img src="assets/${item.image}" alt="${item.nameEn}" class="w-full h-full object-cover"/>
          </div>
          <div>
            <h4 class="font-semibold text-sm">${item.name}</h4>
            <p class="text-xs text-gray-600">${item.weight}g - ${money(item.price)}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="changeCartQuantity(${item.id},${item.weight},-1)" class="w-6 h-6 bg-gray-200 rounded-full text-sm">-</button>
          <span class="w-8 text-center text-sm">${item.quantity}</span>
          <button onclick="changeCartQuantity(${item.id},${item.weight},1)" class="w-6 h-6 bg-gray-200 rounded-full text-sm">+</button>
          <button onclick="removeFromCart(${idx})" class="text-red-500 ml-2">🗑️</button>
        </div>
      </div>
    `).join('');
    $('total-amount').textContent=money(total);
    $('cart-total-block').classList.remove('hidden');
    $('checkout-form').classList.remove('hidden');

    // refresh UPI link with exact amount & bind screenshot input
    attachPaymentListeners();

    // render upsell every time cart changes
    renderUpsell();
  }

  /********** UPI **********/
  function buildUpiLink(amount){
    const pa = encodeURIComponent(UPI_VPA);
    const pn = encodeURIComponent(SHOP_NAME);
    const tn = encodeURIComponent('Papadsale Order');
    const am = encodeURIComponent(amount.toFixed(2));
    return `upi://pay?pa=${pa}&pn=${pn}&tn=${tn}&am=${am}&cu=INR`;
  }
  function openUpiLink(upiUrl){
    const start = Date.now();
    window.location.href = upiUrl;
    setTimeout(()=>{
      if ((Date.now()-start) < 1400) {
        alert('If your UPI app did not open, please scan the QR shown below and then upload your screenshot.');
      }
    }, 1200);
  }
  function attachPaymentListeners(){
    const payLink = $('payUPI');
    if (payLink){
      const upi = buildUpiLink(cartTotal());
      payLink.onclick = (e)=>{ e.preventDefault(); openUpiLink(upi); };
    }
    const input = $('payment-screenshot');
    if (input && !input._bound){
      input._bound = true;
      input.addEventListener('change', handleScreenshotUpload);
    }
  }

  /********** PAYMENT VERIFICATION (OCR) **********/
  async function handleScreenshotUpload(e){
    uploadedScreenshotFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
    $('confirmPaymentBtn').disabled = true;
    $('ocr-status').textContent = '';
    ocrDetectedAmount = null;

    if (!uploadedScreenshotFile) return;

    $('ocr-status').textContent = 'Reading screenshot to detect paid amount...';
    try {
      const { data:{ text } } = await Tesseract.recognize(uploadedScreenshotFile, 'eng');
      const detected = extractAmount(text);
      const total = cartTotal();

      if (detected != null){
        ocrDetectedAmount = detected;
        const diff = Math.abs(detected - total);
        if (diff <= OCR_TOLERANCE){
          $('ocr-status').innerHTML = `✅ Verified payment amount appears to be <strong>₹${detected.toFixed(2)}</strong> (matches your total ₹${total.toFixed(2)}).`;
          $('confirmPaymentBtn').disabled = false;
        } else {
          $('ocr-status').innerHTML = `❌ Detected amount <strong>₹${detected.toFixed(2)}</strong> does not match your total <strong>₹${total.toFixed(2)}</strong>. Please ensure you paid the exact amount, re-upload a clearer screenshot, or contact us.`;
        }
      } else {
        $('ocr-status').innerHTML = '⚠️ Could not read an amount from the image. Please ensure the amount is visible or re-upload.';
      }
    } catch(err){
      console.warn(err);
      $('ocr-status').textContent = '⚠️ Unable to read the image. Please try again or upload a clearer screenshot.';
    }
  }

  // extract a rupee-like amount from OCR text
  function extractAmount(text){
    if (!text) return null;
    const t = text.replace(/[,]/g,'').replace(/₹/g,' INR ');
    const re1 = /(INR|Rs\.?|Amount|Paid)\s*[:\-]?\s*([0-9]+(?:\.[0-9]{1,2})?)/ig;
    let m, candidates=[];
    while ((m = re1.exec(t)) !== null){ candidates.push(parseFloat(m[2])); }
    if (candidates.length === 0){
      const re2 = /([0-9]{2,6}(?:\.[0-9]{1,2})?)/g;
      while ((m = re2.exec(t)) !== null){ 
        const v = parseFloat(m[1]);
        if (v >= 10) candidates.push(v);
      }
    }
    if (candidates.length === 0) return null;
    return Math.max(...candidates);
  }

  /********** WHATSAPP **********/
  function buildWhatsAppText(includeScreenshotURL){
    let total = cartTotal();
    let lines = '';
    cart.forEach(it=>{ const s=it.price*it.quantity; lines += `• ${it.name} (${it.weight}g) × ${it.quantity} = ₹${s}\n`; });
    const name=$('customer-name')?.value||'';
    const mobile=$('customer-mobile')?.value||'';
    const address=$('customer-address')?.value||'';
    const pincode=$('customer-pincode')?.value||'';
    const landmark=$('customer-landmark')?.value||'';
    const notes=$('order-notes')?.value||'';
    let msg = `🛒 *NEW ORDER - ${SHOP_NAME.toUpperCase()}*%0A%0A`;
    msg += `📦 *Items:*%0A${encodeURIComponent(lines).replace(/%250A/g,'%0A')}`;
    msg += `%0A💰 *Total:* ₹${total.toFixed(2)}%0A`;
    if (ocrDetectedAmount!=null) msg += `✅ *Paid:* ₹${ocrDetectedAmount.toFixed(2)}%0A`;
    msg += `%0A👤 *Customer*%0A`;
    if (name) msg += `Name: ${encodeURIComponent(name)}%0A`;
    if (mobile) msg += `Mobile: ${encodeURIComponent(mobile)}%0A`;
    if (address) msg += `Address: ${encodeURIComponent(address)}%0A`;
    if (pincode) msg += `Pincode: ${encodeURIComponent(pincode)}%0A`;
    if (landmark) msg += `Landmark: ${encodeURIComponent(landmark)}%0A`;
    if (notes) msg += `%0A📝 Notes: ${encodeURIComponent(notes)}%0A`;
    if (includeScreenshotURL && uploadedScreenshotURL) {
      msg += `%0A📸 Payment screenshot: ${encodeURIComponent(uploadedScreenshotURL)}%0A`;
    } else {
      msg += `%0A📸 Payment screenshot uploaded by customer (file cannot be auto-attached to WhatsApp link).%0A`;
    }
    msg += `%0A🙏 Thank you!`;
    return msg;
  }

  async function confirmPaymentAndSend(){
    // basic required fields
    const req=['customer-name','customer-mobile','customer-address','customer-pincode'];
    for (const id of req){ const el=$(id); if (!el || !el.value.trim()){ alert('Please fill in all required fields'); return; } }
    if (!uploadedScreenshotFile){ alert('Please upload the payment screenshot.'); return; }
    if ($('confirmPaymentBtn').disabled){ alert('Payment amount not verified yet. Please upload a clear screenshot.'); return; }

    // Optional: upload screenshot to your server for URL
    if (ADMIN_UPLOAD_ENDPOINT){
      try{
        const fd = new FormData();
        fd.append('file', uploadedScreenshotFile);
        const r = await fetch(ADMIN_UPLOAD_ENDPOINT,{ method:'POST', body:fd });
        if (r.ok){
          const j = await r.json();
          if (j && j.url) uploadedScreenshotURL = j.url;
        }
      } catch(e){ console.warn('Upload failed, proceeding without URL'); }
    }

    // Send to Admin
    const adminText = buildWhatsAppText(true);
    const adminURL  = `https://wa.me/${ADMIN_WHATSAPP}?text=${adminText}`;
    window.open(adminURL,'_blank');

    // Optional: send to customer
    if ($('send-summary-to-self')?.checked){
      const customerNum = ($('customer-mobile')?.value||'').replace(/\D/g,'');
      if (customerNum.length===10){
        const summary = `🧾 *Order Summary - ${SHOP_NAME}*%0A%0A` + buildWhatsAppText(false);
        const customerURL = `https://wa.me/91${customerNum}?text=${summary}`;
        setTimeout(()=>window.open(customerURL,'_blank'), 600);
      }
    }

    // Clear cart & show success
    cart = [];
    updateCartUI();
    $('cart-drawer').classList.remove('open');
    $('success-modal').classList.add('show');
  }

  function closeModal(){ $('success-modal').classList.remove('show'); }

  /********** UPSELL **********/
  function getUpsellItems() {
    if (!cart.length) return [];
    const catCount = {};
    cart.forEach(i => {
      const p = products.find(x => x.id === i.id);
      if (p) catCount[p.category] = (catCount[p.category] || 0) + 1;
    });
    const topCat = Object.entries(catCount).sort((a,b)=>b[1]-a[1])[0]?.[0];
    const pool = products.filter(p => !cart.some(c => c.id === p.id));
    const score = (p) => {
      let s = 0;
      if (p.category === topCat) s += 3;
      if (p.badge && /best|crispy|popular|classic/i.test(p.badge)) s += 2;
      s += (p.price500 ? 1/(p.price500+1) : 0);
      return s;
    };
    return pool.map(p=>({p,s:score(p)})).sort((a,b)=>b.s-a.s).slice(0,3).map(x=>x.p);
  }
  function renderUpsell() {
    const section = $('upsell-section');
    const list = $('upsell-items');
    if (!section || !list) return;
    if (!cart.length){ section.classList.add('hidden'); list.innerHTML=''; return; }
    const recs = getUpsellItems();
    if (!recs.length){ section.classList.add('hidden'); list.innerHTML=''; return; }
    section.classList.remove('hidden');
    list.innerHTML = recs.map(p => `
      <div class="flex items-center justify-between p-3 bg-cream rounded-lg">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100">
            <img loading="lazy" src="assets/${p.image}" alt="${p.name}" class="w-full h-full object-cover">
          </div>
          <div>
            <p class="font-medium text-sm">${p.name}</p>
            <p class="text-xs text-gray-600">₹${p.price500} • 500g</p>
          </div>
        </div>
        <button class="text-white bg-saffron px-3 py-1.5 rounded-lg text-sm" onclick="addQuickUpsell(${p.id})">Add</button>
      </div>
    `).join('');
  }
  function addQuickUpsell(id) {
    const p = products.find(x => x.id === id);
    if (!p) return;
    const existing = cart.find(i => i.id === id && i.weight === 500);
    if (existing) existing.quantity += 1;
    else cart.push({ id: p.id, name: p.name, nameEn: p.nameEn, price: p.price500, weight: 500, quantity: 1, image: p.image });
    updateCartUI();
    toast(`${p.name} added`);
  }

  /********** REVIEWS RENDER/FORM **********/
  function getStoredReviews(){
    const raw = localStorage.getItem('papadsale_reviews');
    let arr = raw ? JSON.parse(raw) : [];
    if (!localStorage.getItem('papadsale_seeded')){
      arr = [...seedReviews, ...arr];
      localStorage.setItem('papadsale_seeded','1');
      localStorage.setItem('papadsale_reviews', JSON.stringify(arr));
    }
    return arr;
  }
  function setStoredReviews(list){
    localStorage.setItem('papadsale_reviews', JSON.stringify(list));
  }
  function renderReviews(){
    const wrap = $('reviews-list');
    const list = getStoredReviews();
    if (!list.length){ wrap.innerHTML = '<p class="text-center text-gray-500 col-span-full">No reviews yet. Be the first to review!</p>'; return; }
    wrap.innerHTML = list.slice(0,12).map(r=>{
      const stars = '★'.repeat(r.rating) + '☆'.repeat(5-r.rating);
      return `
        <div class="bg-white rounded-2xl p-5 soft-shadow">
          <div class="flex items-center justify-between">
            <p class="font-semibold">${r.name}${r.city?` • <span class='text-gray-500 text-sm'>${r.city}</span>`:''}</p>
            <p class="text-yellow-500">${stars}</p>
          </div>
          <p class="text-gray-700 mt-2 text-sm">${r.text}</p>
        </div>
      `;
    }).join('');
  }
  function wireStars(){
    const box = $('rev-stars');
    if (!box) return;
    box.querySelectorAll('.star').forEach(st=>{
      st.addEventListener('mouseenter',()=>paintStars(+st.dataset.v));
      st.addEventListener('click',()=>{ currentStars = +st.dataset.v; paintStars(currentStars); });
    });
    box.addEventListener('mouseleave',()=>paintStars(currentStars));
    paintStars(currentStars);
  }
  function paintStars(n){
    const box = $('rev-stars');
    box.querySelectorAll('.star').forEach(st=> st.classList.toggle('on', +st.dataset.v <= n));
  }
  function submitReview(){
    const name = $('rev-name').value.trim();
    const city = $('rev-city').value.trim();
    const text = $('rev-text').value.trim();
    if (!name || !text){ alert('Please enter your name and review.'); return; }
    const list = getStoredReviews();
    list.unshift({name, city, rating: currentStars, text});
    setStoredReviews(list);
    $('rev-name').value=''; $('rev-city').value=''; $('rev-text').value='';
    renderReviews();
    toast('Thank you for your review!');
  }

  /********** FAQ **********/
  function renderFAQ(){
    const root = $('faq-acc');
    root.innerHTML = faqs.map((f,i)=>`
      <div class="bg-white rounded-xl border">
        <button class="w-full text-left px-5 py-4 flex justify-between items-center" onclick="toggleFaq(${i})">
          <span class="font-medium">${f.q}</span>
          <span id="faq-ico-${i}" class="text-xl">+</span>
        </button>
        <div id="faq-body-${i}" class="hidden px-5 pb-5 text-gray-700">${f.a}</div>
      </div>
    `).join('');
  }
  function toggleFaq(i){
    const body = $('faq-body-'+i);
    const ico = $('faq-ico-'+i);
    body.classList.toggle('hidden');
    ico.textContent = body.classList.contains('hidden') ? '+' : '–';
  }

  /********** COUNTER ANIMATION **********/
  function animateCounters(){
    const els = document.querySelectorAll('.counter');
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const el = entry.target;
          const target = +el.dataset.target;
          let current = 0;
          const step = Math.max(1, Math.floor(target/120));
          const iv = setInterval(()=>{
            current += step;
            if (current >= target){ current = target; clearInterval(iv); }
            el.textContent = current.toLocaleString('en-IN');
          }, 16);
          io.unobserve(el);
        }
      });
    }, {threshold:0.3});
    els.forEach(el=>io.observe(el));
  }

  /********** INIT **********/
  document.addEventListener('DOMContentLoaded', ()=>{
    renderProducts();
    renderReviews();
    wireStars();
    renderFAQ();
    animateCounters();
    updateCartUI(); // draws cart, attaches pay/screenshot listeners, and upsell
  });

  // Close drawer or modal on outside click
  document.addEventListener('click', (e)=>{
    const drawer=$('cart-drawer'); const cartBtn=e.target.closest('button[onclick="toggleCart()"]');
    if (drawer && drawer.classList.contains('open') && !drawer.contains(e.target) && !cartBtn) drawer.classList.remove('open');
    const modal=$('success-modal'); if (e.target===modal) modal.classList.remove('show');
  });
  </script>
</body>
</html>
